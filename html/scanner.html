<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Escanear QR de Invitación</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body { background: #fbeff2; font-family: Arial, sans-serif; text-align: center; }
    h2 { margin-top: 32px; }
    #reader { margin: 20px auto; width: 350px; }
    .info-box {
      margin: 40px auto;
      padding: 24px 32px;
      background: #fff0f4;
      color: #e14e56;
      border-radius: 12px;
      box-shadow: 0 2px 8px #f5767322;
      width: 380px;
      font-size: 1.2em;
    }
    #btn-confirmar, #btn-nuevo {
      margin: 10px 10px 0 0;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
    }
    #btn-confirmar { background: #f57673; color: white; }
    #btn-nuevo { background: #ffe1ea; color: #e14e56; }
  </style>
</head>
<body>
  <h2>Escanear QR de Invitación</h2>
  <div id="reader"></div>
  <div id="info" class="info-box">Esperando escaneo...</div>
  <script>
    // Cambia este enlace por tu propio endpoint de SheetDB:
    const SHEETDB_URL = "https://sheetdb.io/api/v1/fouso319wc8rv";

    // Función para buscar el invitado en SheetDB
    async function buscarInvitado(nombre, cantidad) {
      const url = `${SHEETDB_URL}?nombre=${encodeURIComponent(nombre)}&cantidad_invitados=${encodeURIComponent(cantidad)}`;
      const res = await fetch(url);
      const data = await res.json();
      return data && data.length > 0 ? data[0] : null;
    }

    // Función para marcar como asistido
    async function confirmarAsistencia(row_id) {
      // Busca el registro y actualiza el campo 'procesado' a 'SI'
      await fetch(`${SHEETDB_URL}/id/${row_id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ procesado: 'SI' })
      });
    }

    // Inicializar el lector de QR
    const info = document.getElementById('info');
    let lastQR = "";

    function reiniciarScanner(html5QrCode) {
      info.innerHTML = "Esperando escaneo...";
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async qrText => {
          if (qrText === lastQR) return; // Evitar doble scan
          lastQR = qrText;
          html5QrCode.stop(); // Detener hasta nueva acción
          const [nombre, cantidad] = qrText.split('|');
          info.innerHTML = `<b>Buscando invitado...</b>`;
          const invitado = await buscarInvitado(nombre, cantidad);
          if (invitado) {
            info.innerHTML = `
              <b>Nombre:</b> ${invitado.nombre} <br>
              <b>Cantidad invitados:</b> ${invitado.cantidad_invitados}<br>
              <b>Acompañantes:</b> ${invitado.invitado_1 || ''} ${invitado.invitado_2 || ''} ${invitado.invitado_3 || ''}
              <br><br>
              <button id="btn-confirmar">Confirmar asistencia</button>
              <button id="btn-nuevo">Escanear otro</button>
            `;
            document.getElementById('btn-confirmar').onclick = async () => {
              await confirmarAsistencia(invitado.id); // Usa el id real del registro
              info.innerHTML = `<b>¡Asistencia confirmada!</b><br>
                                <button id="btn-nuevo">Escanear otro</button>`;
              document.getElementById('btn-nuevo').onclick = () => {
                lastQR = "";
                reiniciarScanner(html5QrCode);
              };
            };
            document.getElementById('btn-nuevo').onclick = () => {
              lastQR = "";
              reiniciarScanner(html5QrCode);
            };
          } else {
            info.innerHTML = `No encontrado o datos incorrectos.<br>
                              <button id="btn-nuevo">Intentar de nuevo</button>`;
            document.getElementById('btn-nuevo').onclick = () => {
              lastQR = "";
              reiniciarScanner(html5QrCode);
            };
          }
        },
        errorMsg => { /* Ignora los errores de lectura */ }
      );
    }

    window.onload = () => {
      const html5QrCode = new Html5Qrcode("reader");
      reiniciarScanner(html5QrCode);
    };
  </script>
</body>
</html>
